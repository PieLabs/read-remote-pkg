"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const log_factory_1 = require("log-factory");
const logger = log_factory_1.buildLogger();
const toParams = (pattern) => {
    let [base, ref] = pattern.value.split('#');
    let [owner, repo] = base.split('/');
    repo = repo.indexOf('/') === -1 ? repo : undefined;
    if (repo.includes('..') || owner.includes('..')) {
        return {};
    }
    else {
        return { owner, repo, ref };
    }
};
class Github {
    match(pattern) {
        try {
            let { owner, repo, ref } = toParams(pattern);
            return owner && repo ? true : false;
        }
        catch (e) {
            return false;
        }
    }
    view(pattern) {
        if (!pattern) {
            return Promise.reject(new Error(`pattern is undefined`));
        }
        logger.info('[view], pattern: ', pattern);
        return new Promise((resolve, reject) => {
            let { owner, repo, ref } = toParams(pattern);
            if (!owner || !repo) {
                logger.error('missing owner or repo in params: ', owner, repo, 'for pattern: ', pattern);
                resolve(undefined);
            }
            const https = require('https');
            let u = `/repos/${owner}/${repo}/contents/package.json`;
            u += ref ? `?ref=${ref}` : '';
            var options = {
                hostname: 'api.github.com',
                port: 443,
                path: u,
                method: 'GET',
                headers: {
                    'User-Agent': 'read-remote-pkg'
                }
            };
            let safeParse = (s) => {
                try {
                    return JSON.parse(s);
                }
                catch (e) {
                    return {};
                }
            };
            let req = https.get(options, (res) => {
                logger.debug('statusCode:', res.statusCode);
                if (res.statusCode !== 200) {
                    resolve(undefined);
                    return;
                }
                logger.debug('headers:', res.headers);
                let result = new Buffer('', 'utf8');
                res.on('data', (d) => {
                    result += d;
                });
                res.on('end', (d) => {
                    logger.silly('end: ', result.toString('utf8'));
                    let all = safeParse(result.toString('utf8'));
                    if (!_.isString(all.content)) {
                        reject(new Error(`github response is missing 'content' property`));
                    }
                    let pkgString = Buffer.from(all.content, 'base64').toString('utf8');
                    logger.silly('pkgString: ', pkgString);
                    let parsed = safeParse(pkgString);
                    logger.silly('parsed: ', parsed);
                    resolve(parsed);
                });
            });
            req.on('error', (e) => {
                resolve(undefined);
            });
        });
    }
}
exports.Github = Github;
exports.default = new Github();

//# sourceMappingURL=data:application/json;charset=utf8;base64,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TUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUMsQ0FBQztvQkFDckUsQ0FBQztvQkFFRCxJQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNwRSxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDdkMsSUFBSSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUNsQyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztvQkFDakMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRUgsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2dCQUNoQixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDckIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQXZGRCx3QkF1RkM7QUFFRCxrQkFBZSxJQUFJLE1BQU0sRUFBRSxDQUFDIiwiZmlsZSI6ImdpdGh1Yi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgS2V5VmFsdWUsIFZpZXdlciB9IGZyb20gJy4vaW5kZXgnO1xuXG5pbXBvcnQgeyBidWlsZExvZ2dlciB9IGZyb20gJ2xvZy1mYWN0b3J5JztcblxuY29uc3QgbG9nZ2VyID0gYnVpbGRMb2dnZXIoKTtcblxuY29uc3QgdG9QYXJhbXMgPSAocGF0dGVybjogS2V5VmFsdWUpOiBhbnkgPT4ge1xuICBsZXQgW2Jhc2UsIHJlZl0gPSBwYXR0ZXJuLnZhbHVlLnNwbGl0KCcjJyk7XG4gIGxldCBbb3duZXIsIHJlcG9dID0gYmFzZS5zcGxpdCgnLycpO1xuICByZXBvID0gcmVwby5pbmRleE9mKCcvJykgPT09IC0xID8gcmVwbyA6IHVuZGVmaW5lZDtcbiAgaWYgKHJlcG8uaW5jbHVkZXMoJy4uJykgfHwgb3duZXIuaW5jbHVkZXMoJy4uJykpIHtcbiAgICByZXR1cm4ge307XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHsgb3duZXIsIHJlcG8sIHJlZiB9O1xuICB9XG59O1xuXG5leHBvcnQgY2xhc3MgR2l0aHViIGltcGxlbWVudHMgVmlld2VyIHtcblxuICBtYXRjaChwYXR0ZXJuOiBLZXlWYWx1ZSk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgeyBvd25lciwgcmVwbywgcmVmIH0gPSB0b1BhcmFtcyhwYXR0ZXJuKTtcbiAgICAgIHJldHVybiBvd25lciAmJiByZXBvID8gdHJ1ZSA6IGZhbHNlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICB2aWV3KHBhdHRlcm46IEtleVZhbHVlKTogUHJvbWlzZTxhbnkgfCB1bmRlZmluZWQ+IHtcblxuICAgIGlmICghcGF0dGVybikge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgcGF0dGVybiBpcyB1bmRlZmluZWRgKSk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oJ1t2aWV3XSwgcGF0dGVybjogJywgcGF0dGVybik7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IHsgb3duZXIsIHJlcG8sIHJlZiB9ID0gdG9QYXJhbXMocGF0dGVybik7XG5cbiAgICAgIGlmICghb3duZXIgfHwgIXJlcG8pIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdtaXNzaW5nIG93bmVyIG9yIHJlcG8gaW4gcGFyYW1zOiAnLCBvd25lciwgcmVwbywgJ2ZvciBwYXR0ZXJuOiAnLCBwYXR0ZXJuKTtcbiAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XG5cbiAgICAgIGxldCB1ID0gYC9yZXBvcy8ke293bmVyfS8ke3JlcG99L2NvbnRlbnRzL3BhY2thZ2UuanNvbmA7XG4gICAgICB1ICs9IHJlZiA/IGA/cmVmPSR7cmVmfWAgOiAnJztcblxuICAgICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICAgIGhvc3RuYW1lOiAnYXBpLmdpdGh1Yi5jb20nLFxuICAgICAgICBwb3J0OiA0NDMsXG4gICAgICAgIHBhdGg6IHUsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnVXNlci1BZ2VudCc6ICdyZWFkLXJlbW90ZS1wa2cnXG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGxldCBzYWZlUGFyc2UgPSAoczogc3RyaW5nKTogYW55ID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJldHVybiB7fTtcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgbGV0IHJlcSA9IGh0dHBzLmdldChvcHRpb25zLCAocmVzKSA9PiB7XG4gICAgICAgIGxvZ2dlci5kZWJ1Zygnc3RhdHVzQ29kZTonLCByZXMuc3RhdHVzQ29kZSk7XG5cbiAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlICE9PSAyMDApIHtcbiAgICAgICAgICByZXNvbHZlKHVuZGVmaW5lZCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdoZWFkZXJzOicsIHJlcy5oZWFkZXJzKTtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gbmV3IEJ1ZmZlcignJywgJ3V0ZjgnKTtcblxuICAgICAgICByZXMub24oJ2RhdGEnLCAoZCkgPT4ge1xuICAgICAgICAgIHJlc3VsdCArPSBkO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXMub24oJ2VuZCcsIChkKSA9PiB7XG4gICAgICAgICAgbG9nZ2VyLnNpbGx5KCdlbmQ6ICcsIHJlc3VsdC50b1N0cmluZygndXRmOCcpKTtcbiAgICAgICAgICBsZXQgYWxsID0gc2FmZVBhcnNlKHJlc3VsdC50b1N0cmluZygndXRmOCcpKTtcblxuICAgICAgICAgIGlmICghXy5pc1N0cmluZyhhbGwuY29udGVudCkpIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYGdpdGh1YiByZXNwb25zZSBpcyBtaXNzaW5nICdjb250ZW50JyBwcm9wZXJ0eWApKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQgcGtnU3RyaW5nID0gQnVmZmVyLmZyb20oYWxsLmNvbnRlbnQsICdiYXNlNjQnKS50b1N0cmluZygndXRmOCcpO1xuICAgICAgICAgIGxvZ2dlci5zaWxseSgncGtnU3RyaW5nOiAnLCBwa2dTdHJpbmcpO1xuICAgICAgICAgIGxldCBwYXJzZWQgPSBzYWZlUGFyc2UocGtnU3RyaW5nKTtcbiAgICAgICAgICBsb2dnZXIuc2lsbHkoJ3BhcnNlZDogJywgcGFyc2VkKTtcbiAgICAgICAgICByZXNvbHZlKHBhcnNlZCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIHJlcS5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICByZXNvbHZlKHVuZGVmaW5lZCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgR2l0aHViKCk7XG4iXX0=
